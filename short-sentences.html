<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8" />
        <title>Short sentences from Project Gutenberg Books</title>
        <link href="base.css" rel="stylesheet" type="text/css" />
        <script src="scripts/utils/theme.mjs" type="module"></script>
        <link href="style.less" rel="stylesheet/less" type="text/css" />
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> -->

        <script src="scripts/libs/less.js" ></script>
        <script src="scripts/libs/chart.js"></script>
        <script src="scripts/libs/chartjs-plugin-datalabels.js"></script>
        <script src="scripts/libs/jquery-3.6.0.min.js"></script>
        <link rel="stylesheet" type="text/css" href="font-roboto.css" />
    </head>
    <body>
        <div id="lesson" class="wrapper"></div>

        <script type="module">

            import { setTheme, displayOnly, prepareInput, loadSettings,storageAvailable,populatePage,getFormFields,parseQueryString,prepareNextSeed } from "./scripts/utils/util.mjs";
            import {numberSentences} from "./scripts/number-sentences.mjs";
            import {TypeJig,setExercise } from "./scripts/type-jig.mjs";
            import {wordDrill} from "./scripts/word-drill.mjs";
            import {WordSets} from "./scripts/word-sets.mjs";
            import {PRNG} from "./scripts/alea-prng.mjs";

            import {shortSentences} from "./data/short-sentences-data.mjs"

            setTheme();
            const choose = (a, rnd) => a[Math.floor(rnd() * a.length)];

            function generateExercise(wordCount, rnd) {
                let prevElements = [],
                    element;
                let words = [];
                let charsLeft = wordCount * 5 + 1;
                while (charsLeft > 0) {
                    do {
                        element = choose(shortSentences, rnd);
                    } while (prevElements.includes(element));
                    if (prevElements.length > 20) prevElements.shift();
                    prevElements.push(element);
                    const string =
                        typeof element === "string"
                            ? element
                            : element.join(" ");
                    const array = Array.isArray(element)
                        ? element
                        : element.split(/\s+/);
                    charsLeft -= 1 + string.length;
                    words.splice(words.length, 0, ...array);
                }
                return new TypeJig.Exercise(words, 0, false, "ordered");
            }

            $(document).ready(function () {
                populatePage();
                var fields = parseQueryString(document.location.search);

                if (!fields.seed) {
                    fields.seed = "" + Math.random();
                    window.history.replaceState(
                        "",
                        "",
                        updateURLParameter(
                            window.location.href,
                            "seed",
                            fields.seed
                        )
                    );
                }
                var rng = PRNG(fields.seed);

                var wordCount =
                    fields.word_count == null
                        ? 100
                        : parseInt(fields.word_count);

                var name = "Short Sentences";

                var exercise = generateExercise(wordCount, rng);

                var jig = setExercise(name, exercise, null, fields);

                var back = document.getElementById("back");
                var again = document.getElementById("again");
                var end = document.getElementById("end");
                var another = document.getElementById("new");
                var nextSeed = prepareNextSeed(another);
                back.href = back.href.replace("short-sentences", "form");
                again.addEventListener("click", function (evt) {
                    evt.preventDefault();
                    jig.reset();
                });
                end.addEventListener("click", function (evt) {
                    evt.preventDefault();
                    jig.endExercise();
                });
                another.addEventListener("click", function (evt) {
                    evt.preventDefault();
                    window.history.replaceState(
                        "",
                        "",
                        updateURLParameter(
                            window.location.href,
                            "seed",
                            nextSeed
                        )
                    );
                    let exercise = generateExercise(wordCount, PRNG(nextSeed));
                    jig.exercise = exercise;
                    jig.reset();
                    nextSeed = prepareNextSeed(another);
                });

            });
        </script>
    </body>
</html>
