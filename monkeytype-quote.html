<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Steno Jig</title>
        <link href="style.css" rel="stylesheet" type="text/css" />
        <script src="type-jig.js"></script>
        <script src="utils/util.js"></script>
        <script src="utils/steno-display.js"></script>
        <script src="plover-translations.js"></script>
        <script src="data/monkeytype-quote-data.js"></script>
        <script src="libs/jquery-3.6.0.min.js"></script>
        <script src="libs/chart.js"></script>
        <script src="chartjs-plugin-datalabels.js"></script>
        <script src="spectra/spectra.js"></script>
        <script src="spectra/rules.js"></script>
        <link rel="stylesheet" type="text/css" href="font-roboto.css" />
    </head>
    <body>
        <div id="lesson" class="wrapper"></div>

        <script>
            setTheme();
            function getQuoteById(id) {
                id = +id;
                const quotes = monkeytype.quotes;
                for (let i = 0; i < quotes.length; ++i) {
                    if (quotes[i].id === id) return quotes[i];
                }
            }

            function getQuoteByLength(lo, hi) {
                const quotes = monkeytype.quotes.filter(
                    (q) => q.text.length >= lo && q.text.length <= hi
                );
                return quotes[Math.floor(quotes.length * Math.random())];
            }

            function getQuote(id, lo, hi) {
                if (id != null) return getQuoteById(id);
                else return getQuoteByLength(lo, hi);
            }

            function generateExercise(id, lo, hi) {
                const quote = getQuote(id, lo, hi);
                const words = quote.text.trim().split(/\s+/);
                const exercise = new TypeJig.Exercise(
                    words,
                    0,
                    false,
                    "ordered"
                );
                exercise.name =
                    "Monkeytype English Quote #" +
                    quote.id +
                    " (from " +
                    quote.source +
                    ")";
                exercise.quote = quote;
                return exercise;
            }

            function replaceID(href, id) {
                console.log(href, id);
                let [h, q] = href.split("?");
                q = (q || "").split("&").filter((x) => !/^id=/.test(x));
                if (id) q.push("id=" + id);
                return h + "?" + q.join("&");
            }
            let jig, exercise, fields;

            function getExercise(fields) {
                console.log(fields);
                switch (fields.length) {
                    case "short":
                        fields.lo = 0;
                        fields.hi = 100;
                        break;
                    case "medium":
                        fields.lo = 101;
                        fields.hi = 300;
                        break;
                    case "long":
                        fields.lo = 301;
                        fields.hi = 600;
                        break;
                    case "thicc":
                        fields.lo = 601;
                        fields.hi = Infinity;
                        break;
                    case "all":
                    default:
                        fields.lo = 0;
                        fields.hi = Infinity;
                        break;
                }
                return generateExercise(fields.id, fields.lo, fields.hi);
            }

            function go(ex) {
                fields = parseQueryString(document.location.search);
                if (ex == null) {
                    exercise = getExercise(fields);
                } else exercise = ex;

                jig = setExercise(exercise.name, exercise, null, fields, jig);
            }
            $(document).ready(function () {
                populatePage();
                loadSettings();

                go();
                window.history.replaceState(
                    null,
                    "",
                    replaceID(document.location.href, exercise.quote.id)
                );
                initializeButtons(jig);

                let another = document.getElementById("new");

                let fields = parseQueryString(document.location.search);
                fields.id = null;
                let nextExercise = getExercise(fields);
                another.href = replaceID(
                    document.location.href,
                    nextExercise?.quote?.id
                );
                window.addEventListener("popstate", function () {
                    go();
                });
            });
        </script>
    </body>
</html>
