<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8" />
        <title>Finger Drills</title>
        <link href="base.css" rel="stylesheet" type="text/css" />
        <script src="scripts/utils/theme.mjs" type="module"></script>


        <link href="style.less" rel="stylesheet/less" type="text/css" />
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> -->

        <script src="scripts/libs/less.js" ></script>
        <script src="scripts/libs/chart.js"></script>
        <script src="scripts/libs/chartjs-plugin-datalabels.js"></script>
        <script src="scripts/libs/jquery-3.6.0.min.js"></script>

        <link rel="stylesheet" type="text/css" href="font-roboto.css" />
    </head>
    <body>
        <div id="lesson" class="wrapper"></div>
    </body>
    <script type="module">
        import { setTheme, displayOnly, prepareInput, loadSettings,storageAvailable,populatePage,getFormFields ,parseQueryString} from "./scripts/utils/util.mjs";
        import {numberSentences} from "./scripts/number-sentences.mjs";
        import {TypeJig, setExercise} from "./scripts/type-jig.mjs";
        import {wordDrill} from "./scripts/word-drill.mjs";

        import {dreadedDuo} from "./data/finger-drill-data.mjs";
        setTheme();

        function addSet(strokes, iterations, drill) {
            if (drill == null) drill = [];
            strokes = strokes.split("/");
            if (drill.length === 0) {
                drill.push.apply(drill, strokes);
                --iterations;
            }
            strokes[0] = "\n" + strokes[0];
            for (let i = 0; i < iterations; ++i) {
                drill.push.apply(drill, strokes);
            }
            drill.push(strokes[0]);
            return drill;
        }

        function generateFingerDrill(drills, iterations, name) {
            let out = [];
            for (const drill of drills) addSet(drill, iterations, out);
            var exercise = new TypeJig.Exercise(out, 0, false, "ordered");
            if (name) exercise.name = name;
            else exercise.name = "Finger Drill: " + drills.join(" ");
            return exercise;
        }

        function generateDreadedDuoDrill(section, drill, iterations) {
            let n = dreadedDuo[section - 1].length;
            let name = "Da Dreaded Dueling Digit Duo Drills";
            name += " (Section " + section + ", #" + drill + " of " + n + ")";
            let drills = [dreadedDuo[section - 1][drill - 1]];
            let exercise = generateFingerDrill(drills, iterations, name);
            return exercise;
        }

        function linkNextDrill(link, fields, updateFields) {
            var section = fields.section,
                drill = fields.drill;
            if (drill === dreadedDuo[section - 1].length) {
                drill = 1;
                if (section === dreadedDuo.length) section = 1;
                else ++section;
            } else ++drill;
            let url = updateURLParameter(
                window.location.href,
                "section",
                section
            );
            url = updateURLParameter(url, "drill", drill);
            link.href = url;
            if (updateFields) {
                fields.section = section;
                fields.drill = drill;
            }
        }
        $(document).ready(function () {
            populatePage({
                require_raw_steno: true,
            });
            var fields = parseQueryString(document.location.search);
            fields.iterations = fields.iterations || 20;
            fields.actualWords = { unit: "strokes per minute", u: "SPM" };

            let exercise;
            if (fields.strokes) {
                const drills = fields.strokes.split(/\s+/);
                exercise = generateFingerDrill(drills, fields.iterations);
            } else if (fields.book === "Stenotype Finger Technique") {
                let name = fields.book + ": " + fields.section;
                const drills = stenotypeFingerTechnique[fields.section];
                exercise = generateFingerDrill(drills, fields.iterations, name);
            } else {
                fields.section = Math.max(
                    1,
                    Math.min(fields.section || 1, dreadedDuo.length)
                );
                fields.drill = Math.max(
                    1,
                    Math.min(
                        fields.drill || 1,
                        dreadedDuo[fields.section - 1].length
                    )
                );
                exercise = generateDreadedDuoDrill(
                    fields.section,
                    fields.drill,
                    fields.iterations
                );
                console.log(exercise);
            }

            var jig = setExercise(exercise.name, exercise, null, fields);
        });
    </script>
</html>
