<html>
    <head>
        <meta charset="utf-8" />
        <title>Improve your mistakes</title>
        <link href="style.css" rel="stylesheet" type="text/css" />
        <script src="type-jig.js"></script>
        <script src="utils/util.js"></script>
        <script src="word-drill.js"></script>
        <script src="utils/steno-display.js"></script>
        <script src="learn-keyboard.js"></script>
        <script src="libs/chart.js"></script>
        <script src="chartjs-plugin-datalabels.js"></script>
        <script src="libs/jquery-3.6.0.min.js"></script>
        <script src="spectra/spectra.js"></script>
        <script src="spectra/rules.js"></script>
        <script src="plover-translations.js"></script>
        <link rel="stylesheet" type="text/css" href="font-roboto.css" />
    </head>
    <body>
        <div class="wrapper">
            <div id="form">
                <h1>Improve your mistakes</h1>
                <!-- <p style="text-align: center">
                    <a href="raw-steno-instructions.html"
                        >How to get raw steno output</a
                    >
                </p> -->
                <div class="form-section">
                    Most messed up words
                    <ul id="most-messed-up-words" style="list-style-type: none">
                        Bad -> back
                    </ul>

                    <!-- <form id="selectDrill">
                        <ul style="list-style-type: none">
                            <li><select name="drill"></select></li>
                            <li>
                                <label
                                    ><input
                                        name="hints"
                                        type="checkbox"
                                        value="yes"
                                        checked
                                    />
                                    Show hints?</label
                                >
                            </li>
                            <li>
                                <label
                                    ><input
                                        name="wpm"
                                        type="number"
                                        value=""
                         var strokes = document.getElementById("strokes");
    if (floating_hints) {
        strokes.style.position = "fixed";
    }
    var translations = TypeJig.shortestTranslations(PloverTranslations);
    console.log("Making stenoDisplay");

    return new StenoDisplay(strokes, translations, true);                step="5"
                                    />
                                    Speed (strokes per minute).</label
                                >
                            </li>
                            <li><input type="submit" value="Go" /></li>
                        </ul>
                    </form> -->
                </div>
            </div>
        </div>

        <div id="lesson" class="wrapper" style="display: none">
            <div id="leftside">
                <h3 id="lesson-name" class="center"></h3>
                <p style="text-align: center; padding-bottom: 3em">
                    <a href="raw-steno-instructions.html"
                        >How to get raw steno output</a
                    >
                </p>
                <div id="drill-content">
                    <div id="answer"></div>
                    <div id="exercise"></div>
                    <div id="results"></div>
                    <div style="height: 300px">
                        <canvas id="chartDiv" width="400" height="400"></canvas>
                    </div>
                </div>
            </div>

            <div id="nav">
                <p id="stroke-hint"></p>
                <p id="strokes"></p>
                <p id="clock" class="clock"></p>
                <p id="live-wpm-display" class="wpm"></p>

                <p class="center">
                    <a id="back" title="LeftArrow"
                        >&larr; Back to Menu
                        <span class="shortcutkey">(LeftArrow)</span></a
                    >
                </p>
                <p class="center">
                    <a id="again" title="Enter"
                        >&#8634; Restart
                        <span class="shortcutkey">(Enter 3x)</span></a
                    >
                </p>
                <p class="center">
                    <a id="end" title="Enter"
                        >&Cross; End
                        <span class="shortcutkey">(Tab 3x)</span></a
                    >
                </p>
            </div>

            <textarea id="input"></textarea>
        </div>
    </body>
    <script>
        setTheme();

        function makeDisplay(element, word) {
            // if (floating_hints) {
            //     strokes.style.position = "fixed";
            // }
            var translations = TypeJig.shortestTranslations(PloverTranslations);
            console.log("Making stenoDisplay");

            var display = new StenoDisplay(element, translations, true);
            display.update(word, 0, 0);
        }
        function makeImprovementPair(mistake) {
            let typed = mistake.typed;
            let expected = mistake.expected;
            let count = mistake.count;
            let beforeWords = mistake.beforeWords;

            var list = $("#most-messed-up-words");

            console.log(list);
            let typedWord = document.createElement("div");
            typedWord.classList.add("strokes");
            typedWord.innerHTML = typed;
            makeDisplay(typedWord, typed);

            let expectedWord = document.createElement("div");
            expectedWord.classList.add("strokes");
            expectedWord.innerHTML = expected;
            makeDisplay(expectedWord, expected);

            //Have the typed word and expected word be side by side in its own div
            let wordPair = document.createElement("div");
            wordPair.classList.add("word-pair");

            let description = document.createElement("div");

            {
                let overallUpdate = document.createElement("h2");
                overallUpdate.innerHTML = typed + " -> " + expected;
                description.append(overallUpdate);
            }

            let descriptionList = document.createElement("ul");
            descriptionList.style.width = "200px";

            //count the number of occuranted of each key in beforeWords

            let beforeWordsCount = {};
            for (let i = 0; i < beforeWords.length; i++) {
                let word = beforeWords[i];
                if (beforeWordsCount[word] == undefined) {
                    beforeWordsCount[word] = 1;
                } else {
                    beforeWordsCount[word]++;
                }
            }

            //for key and value in beforeWordsCount
            for (let key in beforeWordsCount) {
                let value = beforeWordsCount[key];
                let updateItem = document.createElement("li");
                updateItem.innerHTML = "";
                if (value > 1) updateItem.innerHTML = " (" + value + "x) ";
                updateItem.innerHTML +=
                    key + " " + typed + " -> " + key + " " + expected;
                descriptionList.append(updateItem);
            }
            // beforeWords.forEach((beforeWord) => {
            //     let updateItem = document.createElement("li");
            //     updateItem.innerHTML =
            //         beforeWord +
            //         " " +
            //         typed +
            //         " -> " +
            //         beforeWord +
            //         " " +
            //         expected;
            //     descriptionList.append(updateItem);
            // });

            description.append(descriptionList);

            wordPair.appendChild(description);
            wordPair.appendChild(typedWord);
            wordPair.appendChild(expectedWord);

            list.append(wordPair);
        }

        //Loop through all the values in "errors" in localstorage

        let errors = JSON.parse(localStorage.getItem("errors"));

        let countedErrors = {};
        for (let i = 0; i < errors.length; i++) {
            let typed = errors[i][1];
            let expected = errors[i][2];
            if (countedErrors[typed + "_=_" + expected] === undefined) {
                countedErrors[typed + "_=_" + expected] = {
                    count: 0,
                    typed: typed,
                    expected: expected,
                    beforeWords: [],
                };
            }
            countedErrors[typed + "_=_" + expected].count++;
            countedErrors[typed + "_=_" + expected].beforeWords.push(
                errors[i][0]
            );
        }

        //sort countedErrors by their count
        let sortedCountedErrors = Object.values(countedErrors).sort(
            (a, b) => b.count - a.count
        );

        //filter it by the top 20
        let top20 = sortedCountedErrors.slice(0, 20);
        top20.forEach((mistake) => {
            makeImprovementPair(mistake);
        });

        //get the ul with the ID of "most-messed-up-words"
        //Using JQuery
    </script>
</html>
